<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.71">
<link rel="alternate" type="application/rss+xml" href="/News/rss.xml" title="qNimble Quarto Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/News/atom.xml" title="qNimble Quarto Blog Atom Feed">
<script src="https://getinsights.io/js/insights.js" defer="defer" onload='insights.init("nJ5SrJEyZ3crqT00"),insights.trackPages()'></script>
<script src="https://plausible.io/js/plausible.js" async defer="defer" data-domain="dev.qnimble.com"></script><title data-react-helmet="true">Measuring Response Time | qNimble Quarto</title><meta data-react-helmet="true" property="og:url" content="https://docs.qnimble.com/Quarto/AppNotes/MeasureLatency"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-quarto-current"><meta data-react-helmet="true" property="og:title" content="Measuring Response Time | qNimble Quarto"><meta data-react-helmet="true" name="description" content="Measuring Response Time (Latency &amp; Jitter)"><meta data-react-helmet="true" property="og:description" content="Measuring Response Time (Latency &amp; Jitter)"><link data-react-helmet="true" rel="shortcut icon" href="/img/profile-256.png"><link data-react-helmet="true" rel="canonical" href="https://docs.qnimble.com/Quarto/AppNotes/MeasureLatency"><link data-react-helmet="true" rel="alternate" href="https://docs.qnimble.com/Quarto/AppNotes/MeasureLatency" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://docs.qnimble.com/Quarto/AppNotes/MeasureLatency" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.6d54aa39.css">
<link rel="preload" href="/assets/js/styles.740386ce.js" as="script">
<link rel="preload" href="/assets/js/runtime~main.a0d93b83.js" as="script">
<link rel="preload" href="/assets/js/main.23642b3c.js" as="script">
<link rel="preload" href="/assets/js/common.ff5cda1f.js" as="script">
<link rel="preload" href="/assets/js/2.a488d900.js" as="script">
<link rel="preload" href="/assets/js/35.6a9b9453.js" as="script">
<link rel="preload" href="/assets/js/36.c2e373cd.js" as="script">
<link rel="preload" href="/assets/js/7876c7ae.8cad9a84.js" as="script">
<link rel="preload" href="/assets/js/17896441.c4038edb.js" as="script">
<link rel="preload" href="/assets/js/57d10e9c.f1077182.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="qNimble" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="qNimble" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">qNimble</strong></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/Quarto/">Quarto</a><a class="navbar__item navbar__link" href="/Contact/">Contact</a><a class="navbar__item navbar__link" href="/News">News</a><a class="navbar__item navbar__link" href="/Store/">Store</a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="qNimble" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="qNimble" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">qNimble</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/Quarto/">Quarto</a></li><li class="menu__list-item"><a class="menu__link" href="/Contact/">Contact</a></li><li class="menu__list-item"><a class="menu__link" href="/News">News</a></li><li class="menu__list-item"><a class="menu__link" href="/Store/">Store</a></li></ul></div></div></div></nav><div class="main-wrapper main-docs-wrapper"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/Quarto/">Overview</a></li><li class="menu__list-item"><a class="menu__link" href="/Quarto/Specifications">Specifications</a></li><li class="menu__list-item"><a class="menu__link" href="/Quarto/Quick_Start">Quick Start Guide</a></li><li class="menu__list-item"><a class="menu__link" href="/Quarto/FAQ">Frequently Asked Questions</a></li><li class="menu__list-item"><a class="menu__link menuLinkText_2aKo">Examples</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Examples/Servo">PID Servo</a></li></ul></li><li class="menu__list-item"><a class="menu__link menuLinkText_2aKo">Software Functions</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Software/ADC">ADC</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Software/DAC">DAC</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Software/Triggers">Triggers</a></li></ul></li><li class="menu__list-item"><a class="menu__link menuLinkText_2aKo">App Notes</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/Quarto/AppNotes/MeasureLatency">Measuring Response Time</a></li></ul></li></ul></div><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_1CGd"><svg width="20" height="20" role="img" class="collapseSidebarButtonIcon_3E-R"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="markdown"><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="measuring-response-time-latency--jitter"></a>Measuring Response Time (Latency &amp; Jitter)<a class="hash-link" href="#measuring-response-time-latency--jitter" title="Direct link to heading">#</a></h1><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="overview"></a>Overview<a class="hash-link" href="#overview" title="Direct link to heading">#</a></h2><p>Whenever you want to interrupt what the MCU is doing to handle something else, you use an interrupt to cause that interruption.  When new ADC data is ready, we use an interrupt to process that new data. Similarly when the USB has incoming data, it will use an interrupt so the MCU can receive the data. Additionally, the <em>Quarto</em> can configure the trigger lines to act as interrupts so the user can externally interrupt the processor. </p><p>One of the key performance specifications of the <em>Quarto</em> is how fast it can respond an event (new data, an external trigger, etc). To measure this, we want to measure the time it takes for the MCU to respond to an interrupt (often called the interrupt latency).  Regardless of the causes of the trigger, the MCU must stop what it is doing and switch to running the function assigned the interrupt that fired. How long this takes depends on what the MCU was in middle of doing.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Interrupt Priority</h5></div><div class="admonition-content"><p>In this application note, we will assume that the interrupt we care about is running at the highest priority. If you have multiple interrupts firing then anything with a lower priority will have to wait for all the higher priority interrupts to complete before they can execute. Additionally, these interrupts can have their execution paused to process a lower priority interrupt.</p></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="trigger-interrupt-latency"></a>Trigger Interrupt Latency<a class="hash-link" href="#trigger-interrupt-latency" title="Direct link to heading">#</a></h2><p>In this example, we will measure the interrupt latency from an external trigger, although the data would look the same for new ADC data as well. Here is basic code for responding to the rising edge on the Trigger 1 line.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c"><div tabindex="0" class="prism-code language-c codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#f8f8f2;background-color:#272822"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">setup</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain">  </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">setTrigger2Direction</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">PIN_DIRECTION_OUTPUT</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Use Trigger 2 as output</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">enableInterruptTrigger1</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">true</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> gotTrigger</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Run gotTrigger on Trigger 1 rising edge</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">int</span><span class="token plain"> triggers </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//store how many triggers have happened</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">gotTrigger</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">void</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">clearISRTrigger1</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// *** Clears interrupt, this **must** be run at start of function!!</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">setTrigger2High</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Set Trigger 2 high so when know when function fires</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">delayNanoseconds</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">50</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Function runs too fast to see Trigger 2 pulse on O-scope otherwise</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  triggers</span><span class="token operator" style="color:#66d9ef">++</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">triggers </span><span class="token operator" style="color:#66d9ef">%</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">2</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">==</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token function" style="color:#e6db74">writeDACRAW1</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">16000</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//Write to DAC on even number of triggers</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token function" style="color:#e6db74">writeDACRAW1</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#66d9ef">-</span><span class="token number" style="color:#ae81ff">16000</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//Write negative value on odd number of triggers</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">setTrigger2Low</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Set Trigger 2 low when function complete</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>An Oscilloscope is configured to display with 10s of persistence we we can see multiple takes on the same screen. The cyan trace shows Trigger 1 and yellow shows Trigger 2.</p><img class="center" src="/img/isr-latency-p1.png"><p>The Trigger 2 goes high about  125ns after the Trigger 1 goes high. So the Interrupt Latency is approximately 125ns. The <code>gotTrigger()</code> function finishes executing about 50ns later, which makes sense given the 50ns delay in that function. Because of the persistence setup on the oscilloscope, the yellow trace is broadened by the timing jitter, as sometimes the response is a little faster or slower. But this is on the order of only 10ns. </p><p>While 125ns latency is terrific, this is under ideal circumstances. The <em>Quarto</em> is doing nothing besides waiting for the Trigger 1 interrupt to happen, so it does not have to stop what it is doing to respond. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="real-world"></a>Real World<a class="hash-link" href="#real-world" title="Direct link to heading">#</a></h2><p>The previous code generated a nice baseline, however, the MCU was never doing anything except handling the Trigger 1 interrupt, so it was in an ideal position to respond quickly. Realistically, the MCU will be busy handling USB data and doing other tasks in the main loop. This will add jitter to the latency as sometimes the MCU is idle and sometimes it has to store what it is working to memory before it can respond to the interrupt. To model this better, we&#x27;ve added a new loop function that the MCU continuously runs. In the loop, we do a few things</p><ul><li>USB: echo back any USB data that is received</li><li>Math: Do a math calculation all the time in the loop function</li><li>LED: Toggle the front panel LED every 500ms</li></ul><p>The new code is:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c"><div tabindex="0" class="prism-code language-c codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#f8f8f2;background-color:#272822"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">setup</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain">  </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">setTrigger2Direction</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">PIN_DIRECTION_OUTPUT</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Use Trigger 2 as output</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">enableInterruptTrigger1</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">true</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> gotTrigger</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Run gotTrigger on Trigger 1 rising edge</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">int</span><span class="token plain"> triggers </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//store how many triggers have happened</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">gotTrigger</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">void</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">clearISRTrigger1</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// *** Clears interrupt, this **must** be run at start of function!!</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">setTrigger2High</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Set Trigger 2 high so when know when function fires</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">delayNanoseconds</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">50</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Function runs too fast to see Trigger 2 pulse on O-scope otherwise</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  triggers</span><span class="token operator" style="color:#66d9ef">++</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">triggers </span><span class="token operator" style="color:#66d9ef">%</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">2</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">==</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token function" style="color:#e6db74">writeDACRAW1</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">16000</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//Write to DAC on even number of triggers</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token function" style="color:#e6db74">writeDACRAW1</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#66d9ef">-</span><span class="token number" style="color:#ae81ff">16000</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//Write negative value on odd number of triggers</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">setTrigger2Low</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Set Trigger 2 low when function complete</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">loop</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">long</span><span class="token plain"> lastrun</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">signed</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">long</span><span class="token plain"> total</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token function" style="color:#e6db74">millis</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token plain"> lastrun </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">500</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//Run once every 500ms            </span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token function" style="color:#e6db74">toggleLEDGreen</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//toggle green LED;            </span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    lastrun </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> lastrun </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">500</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  total </span><span class="token operator" style="color:#66d9ef">+=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">324</span><span class="token operator" style="color:#66d9ef">*</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">total</span><span class="token operator" style="color:#66d9ef">-</span><span class="token number" style="color:#ae81ff">2343</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//do some math in main loop</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">char</span><span class="token plain"> dat</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">Serial</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">available</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    dat </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> Serial</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">read</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//Read USB data if available</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    Serial</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">print</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">dat</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//Echo data back over USB</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain">  </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>An external function generate was used to have Trigger 1 go high at 1 MHz (once per μs) and a python script was used to stream data into and out of the <em>Quarto</em> at ~18 Mbps in both directions. While all this was happening, let&#x27;s look at the response time again with the oscilloscope set at 10s persistence: </p><img class="center" src="/img/isr-latency-p2.png"><p>The response it still usually 125ns, however over 10s there are numerous events where the latency is higher. Especially when using the <em>Quarto</em> for servoing, just as important as the response time is how consistent the response time is. In the worst case Trigger 2 falls 250ns after the rising Trigger 1. That 250 ns includes the interrupt latency, the function execution time and the timing jitter.  With the minimal latency of 125ns and the function taking 50ns to run, the jitter is the remainder: 250ns - 125ns - 50ns = 75ns. So the interrupt latency is bounded to be better than about 200ns. Which is excellent. </p><p>In the example of the <a href="/Quarto/Examples/Servo">PID Servo</a> the full system latency is a little over 4μs, so 75ns of timing jitter is &lt;2%, so a very small effect.</p></div></article><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/Quarto/Software/Triggers"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Triggers</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link">Overview</a></li><li><a href="#trigger-interrupt-latency" class="table-of-contents__link">Trigger Interrupt Latency</a></li><li><a href="#real-world" class="table-of-contents__link">Real World</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/privacy">Privacy Policy</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 <div class="baloo">qNimble</div></div></div></div></footer></div>
<script src="/assets/js/styles.740386ce.js"></script>
<script src="/assets/js/runtime~main.a0d93b83.js"></script>
<script src="/assets/js/main.23642b3c.js"></script>
<script src="/assets/js/common.ff5cda1f.js"></script>
<script src="/assets/js/2.a488d900.js"></script>
<script src="/assets/js/35.6a9b9453.js"></script>
<script src="/assets/js/36.c2e373cd.js"></script>
<script src="/assets/js/7876c7ae.8cad9a84.js"></script>
<script src="/assets/js/17896441.c4038edb.js"></script>
<script src="/assets/js/57d10e9c.f1077182.js"></script>
</body>
</html>