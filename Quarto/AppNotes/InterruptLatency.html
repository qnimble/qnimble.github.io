<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.17">
<meta name="robots" content="noindex, nofollow">
<link rel="alternate" type="application/rss+xml" href="/News/rss.xml" title="qNimble RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/News/atom.xml" title="qNimble Atom Feed">
<link rel="alternate" type="application/json" href="/News/feed.json" title="qNimble JSON Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous">
<script src="https://js.qnimble.com/js/index.js" async defer="defer" data-domain="dev.qnimble.com" data-api="https://js.qnimble.com/qvbt/api/event"></script><title data-rh="true">Measuring Interrupt Latency | qNimble Quarto</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://qnimble.com/img/quarto-frontpanel.jpg"><meta data-rh="true" name="twitter:image" content="https://qnimble.com/img/quarto-frontpanel.jpg"><meta data-rh="true" property="og:url" content="https://qnimble.com/Quarto/AppNotes/InterruptLatency"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-quarto-current"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-quarto-current"><meta data-rh="true" property="og:title" content="Measuring Interrupt Latency | qNimble Quarto"><meta data-rh="true" name="description" content="Overview"><meta data-rh="true" property="og:description" content="Overview"><link data-rh="true" rel="icon" href="/img/profile-256.png"><link data-rh="true" rel="canonical" href="https://qnimble.com/Quarto/AppNotes/InterruptLatency"><link data-rh="true" rel="alternate" href="https://qnimble.com/Quarto/AppNotes/InterruptLatency" hreflang="en"><link data-rh="true" rel="alternate" href="https://qnimble.com/Quarto/AppNotes/InterruptLatency" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.c462e960.css">
<link rel="preload" href="/assets/js/runtime~main.0d03e401.js" as="script">
<link rel="preload" href="/assets/js/main.f554445b.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="qNimble" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo.svg" alt="qNimble" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">qNimble</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/Quarto">Quarto</a><a class="navbar__item navbar__link" href="/Contact">Contact</a><a class="navbar__item navbar__link" href="/News">News</a><a class="navbar__item navbar__link" href="/Orders">Orders</a><a href="https://forum.qnimble.com" target="_target" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Forum<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Quarto">Quarto</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Quarto/Specifications">Specifications</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Quarto/Quick_Start">Quick Start Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Quarto/FAQ">Frequently Asked Questions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Quarto/Troubleshooting">Troubleshooting Guide</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link" href="/Quarto/Examples">Program Examples</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Examples/Filter">Analog Filter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Examples/Pulsed_Output">Pulsed Output Waveform</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Examples/Servo">PID Servo</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link" href="/Quarto/Functions">Software Functions</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Functions/ADC">ADC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Functions/DAC">DAC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Functions/Digital">Digital I/O</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Functions/LEDs">LEDs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Functions/Triggers">Triggers</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active">App Notes</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/AppNotes/AnalogResponseTime">Analog Response Time</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/Quarto/AppNotes/InterruptLatency">Measuring Interrupt Latency</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Quarto/Compliance">Compliance</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_cwdi"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_xORG"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Measuring Interrupt Latency &amp; Jitter</h1><h2 class="anchor anchorWithStickyNavbar_mojV" id="overview">Overview<a class="hash-link" href="#overview" title="Direct link to heading">​</a></h2><p>Whenever you want to micro-controller unit (MCU) to stop what it is doing to handle something else, an interrupt is needed to preempt the current task the MCU is executing.  When new ADC data is ready, we use an interrupt to process that new data. Similarly when the USB has incoming data, an interrupt will fire so the MCU can switch to handling the new USB data.  Interrupts enable a processor to juggle multiple tasks while still responding quickly to important events. </p><p>There are numerous reasons an processor will not respond as quickly to an interrupt as one would like. Many processors use instruction pipelining and caching, and these features reduce the processor&#x27;s ability to quickly run different instructions. Also, processors usually have to spend time storing the working memory of their current task before they can respond to an interrupt. Additionally, some processors need to spend time determining which interrupt fired before the they can respond appropriately. And finally, the software the processor is running can limit the response time by, for example, disabling listening to any interrupts for a period of time. </p><p>In this application note, we will measure the time it takes for the <em>Quarto</em> to respond to an interrupt (often called the interrupt latency).  In order to support quick response times and high servo bandwidth, the <em>Quarto</em> has been designed to have very low interrupt latency. </p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Interrupt Priority</h5></div><div class="admonition-content"><p>In this application note, we will assume that the interrupt we care about is running at the highest priority. If you have multiple interrupts firing then anything with a lower priority will be delayed until the higher priority interrupt finishes. In such a situation, the interrupt latency becomes much more complex for low-priority interrupts.</p></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="trigger-interrupt-latency">Trigger Interrupt Latency<a class="hash-link" href="#trigger-interrupt-latency" title="Direct link to heading">​</a></h2><p>In this example, we will measure the interrupt latency from an external trigger, although the data would look the same for new ADC data as well. Here is basic code for configuring an interrupt to execute the function <code>gotTrigger</code> on the rising edge of Trigger 1.</p><div class="codeBlockContainer_I0IT language-c theme-code-block"><div class="codeBlockContent_wNvx c"><pre tabindex="0" class="prism-code language-c codeBlock_jd64 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">setup</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">triggerMode</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">2</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">OUTPUT</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Use Trigger 2 as output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">enableInterruptTrigger</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">RISING_EDGE</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> gotTrigger</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Run gotTrigger on Trigger 1 rising edge</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">gotTrigger</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">void</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">triggerWrite</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">2</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">HIGH</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Set Trigger 2 to go high so when know when function begins to run</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">delayNanoseconds</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">100</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Function runs too fast to see Trigger 2 pulse on O-scope otherwise</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">triggerWrite</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">2</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">LOW</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Set Trigger 2 go to low when function completes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>An oscilloscope is configured to display with 10s of persistence so we can see multiple trigger responses on the same screen. The cyan trace shows the Trigger 1 input and yellow shows Trigger 2.</p><img class="center" src="/img/isr-latency-p1.png"><p>The Trigger 2 goes high about 110ns after the Trigger 1 goes high. So the Interrupt Latency is approximately 110ns. The <code>gotTrigger()</code> function finishes executing about 90ns later. Because of the persistence setup on the oscilloscope, the yellow trace is broadened by the timing jitter, as sometimes the response is a little faster or slower. But this is on the order of only 10ns. </p><p>While 110ns latency is terrific, this is under ideal circumstances as we will see in the next section.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="latency-under-load">Latency Under Load<a class="hash-link" href="#latency-under-load" title="Direct link to heading">​</a></h2><p>The previous code generated a nice baseline, however, the MCU was never doing anything except handling the Trigger 1 interrupt, so it was in an ideal position to respond quickly. Realistically, the MCU will be busy handling USB data and doing other tasks in the main loop. This will add jitter to the latency as sometimes the MCU is idle and sometimes it has to store what it is working on to memory before it can respond to the interrupt. To model this better, we&#x27;ve added a new loop function that the MCU continuously runs. In the loop, we will do a few things:</p><ul><li>USB: echo back any USB data that is received</li><li>Math: Do a math calculation all the time in the loop function</li><li>LED: Toggle the front panel LED every 500ms</li></ul><p>The new code is:</p><div class="codeBlockContainer_I0IT language-c theme-code-block"><div class="codeBlockContent_wNvx c"><pre tabindex="0" class="prism-code language-c codeBlock_jd64 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">setup</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">triggerMode</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">2</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">OUTPUT</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Use Trigger 2 as output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">enableInterruptTrigger</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">RISING_EDGE</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> gotTrigger</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Run gotTrigger on Trigger 1 rising edge</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">gotTrigger</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">void</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">triggerWrite</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">2</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">HIGH</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Set Trigger 2 to go high so when know when function begins to run</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">delayNanoseconds</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">100</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Function runs too fast to see Trigger 2 pulse on O-scope otherwise  </span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">triggerWrite</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">2</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">LOW</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Set Trigger 2 go to low when function completes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">loop</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">long</span><span class="token plain"> lastrun</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">signed</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">long</span><span class="token plain"> total</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token function" style="color:#e6db74">millis</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token plain"> lastrun </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">500</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//Run once every 500ms            </span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token function" style="color:#e6db74">toggleLEDGreen</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//toggle green LED;            </span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    lastrun </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> lastrun </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">500</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  total </span><span class="token operator" style="color:#66d9ef">+=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">324</span><span class="token operator" style="color:#66d9ef">*</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">total</span><span class="token operator" style="color:#66d9ef">-</span><span class="token number" style="color:#ae81ff">2343</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//do some math in main loop</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">char</span><span class="token plain"> dat</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">Serial</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">available</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    dat </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> Serial</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">read</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//Read USB data if available</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    Serial</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">print</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">dat</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//Echo data back over USB</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>An external function generator was used to have Trigger 1 go from low to high once every 1μs (frequency of 1 MHz) and a python script was used to stream data in and out of the <em>Quarto</em> (18 Mbps down, 18 Mbps up). While all this was happening , let&#x27;s look at the response time again with the oscilloscope still set at 10s persistence: </p><img class="center" src="/img/isr-latency-p2.png"><p>The response it still usually about 110ns, however, over the 10s oscilloscope window, we can see there are numerous events where the latency is higher. Especially when using the <em>Quarto</em> for servoing, the consistency of the response time is just as important as the response time is itself. In the worst case, Trigger 2 falls 275ns after the rising edge of Trigger 1. That 275ns includes the interrupt latency, the function execution time and the maximum timing jitter.  With the minimal latency of 110ns and the function taking 90ns to run, the jitter is the remainder: 275ns - 110ns - 90ns = 75ns. So the interrupt latency varies between 110ns and 185ns. </p><h2 class="anchor anchorWithStickyNavbar_mojV" id="worst-case-latency">Worst-Case Latency<a class="hash-link" href="#worst-case-latency" title="Direct link to heading">​</a></h2><p>There is another limitation on the latency that we haven&#x27;t mentioned: getting data into and out of the floating point unit (FPU). If the main process is doing floating point math (using <code>floats</code> or <code>doubles</code> in C), then it is using the FPU. If an interrupt fires that also needs to do floating point math, then, just like the MCU, the FPU needs to clean up and store what it is working on before it can process the new data. This adds additional jitter to the interrupt latency we measured previously. To test this, we will take our previous code but have both the main loop and the trigger interrupt do math on double precision floats. The new code is below.</p><div class="codeBlockContainer_I0IT language-c theme-code-block"><div class="codeBlockContent_wNvx c"><pre tabindex="0" class="prism-code language-c codeBlock_jd64 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">setup</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">triggerMode</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">2</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">OUTPUT</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Use Trigger 2 as output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">enableInterruptTrigger</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">true</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> gotTrigger</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Run gotTrigger on Trigger 1 rising edge</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> DACout </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//global variable used by main loop and gotTrigger</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">gotTrigger</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">void</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">triggerWrite</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">2</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">HIGH</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Set Trigger 2 to go high so when know when function begins to run</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">writeDAC1</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">DACout</span><span class="token operator" style="color:#66d9ef">*</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">DACout</span><span class="token operator" style="color:#66d9ef">*</span><span class="token number" style="color:#ae81ff">2.342</span><span class="token operator" style="color:#66d9ef">-</span><span class="token number" style="color:#ae81ff">3.232</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//Do some floating point math and then update the DAC with the result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">delayNanoseconds</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">100</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Function runs too fast to see Trigger 2 pulse on O-scope otherwise  </span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">triggerWrite</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">2</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">LOW</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Set Trigger 2 to go low when function completes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">loop</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">long</span><span class="token plain"> lastrun</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">signed</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">long</span><span class="token plain"> total</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token function" style="color:#e6db74">millis</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token plain"> lastrun </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">500</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//Run once every 500ms            </span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token function" style="color:#e6db74">toggleLEDGreen</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//toggle green LED;            </span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    lastrun </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> lastrun </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">500</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  DACout </span><span class="token operator" style="color:#66d9ef">+=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">3.2342</span><span class="token operator" style="color:#66d9ef">*</span><span class="token function" style="color:#e6db74">sin</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">DACout</span><span class="token operator" style="color:#66d9ef">*</span><span class="token number" style="color:#ae81ff">23.234</span><span class="token operator" style="color:#66d9ef">+</span><span class="token number" style="color:#ae81ff">65.324</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//do some FPU math in main loop</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">char</span><span class="token plain"> dat</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">Serial</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">available</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    dat </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> Serial</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">read</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//Read USB data if available</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    Serial</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">print</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">dat</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//Echo data back over USB</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In summary, the <em>Quarto</em> is doing the following:</p><ul><li>Every 1μs, handle external trigger, do floating point math and update the DAC</li><li>Do floating point math in main loop all the time</li><li>Receive USB data at 15 Mbps</li><li>Transmit USB data at 15 Mbps</li></ul><p>In this setup, we get the following latency measurement:</p><img class="center" src="/img/isr-latency-p3.png"><p>The interrupt latency is now rarely at 110ns, but usually closer to 125ns. However, the worst case latency is 210ns. So the interrupt latency varies between 110ns and 210ns and the maximum jitter is now 100ns (before it was 75ns). Additionally, the <code>gotTrigger</code> function now takes 160ns as it is doing math and updating the DAC in addition to the 100ns delay we programmed in. The <code>gotTrigger</code> function sometimes finishes as late as 370ns after the trigger fired, which is consistent with 110ns latency + 100 ns jitter + 160ns execution time.  Even when pushing the <em>Quarto</em> to its limits, the interrupt latency is bounded to be under about 210ns.</p><p>For a 100 kHz PID Servo, the total loop delay is 5us (180° phase shift at 100kHz),  so 100ns of timing jitter is only 2% timing variation, a small effect. Having consistent and bounded interrupt latency is crucial for consistent loop bandwidths and response times.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="footnotes">Footnotes<a class="hash-link" href="#footnotes" title="Direct link to heading">​</a></h2><p>To generate the data presented above, the following python script was used to stream data to and from the <em>Quarto</em>:</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">import</span><span class="token plain"> serial</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">time</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">os</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">ser </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> serial</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Serial</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&#x27;COM4&#x27;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">packets </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">400</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">loops </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">packetSizeSend </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">64</span><span class="token operator" style="color:#66d9ef">*</span><span class="token number" style="color:#ae81ff">64</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">packetSizeReceive </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> packetSizeSend</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">loop</span><span class="token operator" style="color:#66d9ef">=</span><span class="token number" style="color:#ae81ff">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">for</span><span class="token plain"> empty </span><span class="token keyword" style="color:#66d9ef">in</span><span class="token plain"> </span><span class="token builtin" style="color:#e6db74">range</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">loops</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    loop </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> loop </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    start</span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain">time</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">time</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#66d9ef">in</span><span class="token plain"> </span><span class="token builtin" style="color:#e6db74">range</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">packets</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        byte </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">urandom</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">packetSizeSend</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        ser</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">write</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">byte</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        data</span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain">ser</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">read</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">packetSizeReceive</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> byte </span><span class="token operator" style="color:#66d9ef">!=</span><span class="token plain"> data</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">print</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&#x27;Error: Return data does not match. Length = {} and {}&#x27;</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token builtin" style="color:#e6db74">format</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token builtin" style="color:#e6db74">len</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">byte</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token builtin" style="color:#e6db74">len</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    stop</span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain">time</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">time</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    rescaleSend </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">8</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">packetSizeSend</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">packets</span><span class="token operator" style="color:#66d9ef">/</span><span class="token number" style="color:#ae81ff">1000000.0</span><span class="token operator" style="color:#66d9ef">/</span><span class="token builtin" style="color:#e6db74">max</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">.000001</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">stop</span><span class="token operator" style="color:#66d9ef">-</span><span class="token plain">start</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    rescaleReceive </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">8</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">packetSizeReceive</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">packets</span><span class="token operator" style="color:#66d9ef">/</span><span class="token number" style="color:#ae81ff">1000000.0</span><span class="token operator" style="color:#66d9ef">/</span><span class="token builtin" style="color:#e6db74">max</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">.000001</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">stop</span><span class="token operator" style="color:#66d9ef">-</span><span class="token plain">start</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">print</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&#x27;Send Rate: {:0.2f} MBaud, Receive Rate: {:0.2f} MBaud. Got {} kBytes and received {} kBytes in {:0.2f} ms (Loop {}/{})&#x27;</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token builtin" style="color:#e6db74">format</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">rescaleSend</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">rescaleReceive</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">packets</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">packetSizeSend</span><span class="token operator" style="color:#66d9ef">/</span><span class="token number" style="color:#ae81ff">1000</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">packets</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">packetSizeReceive</span><span class="token operator" style="color:#66d9ef">/</span><span class="token number" style="color:#ae81ff">1000</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">stop</span><span class="token operator" style="color:#66d9ef">-</span><span class="token plain">start</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token operator" style="color:#66d9ef">*</span><span class="token number" style="color:#ae81ff">1000</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">loop</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">loops</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">del</span><span class="token plain"> ser</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Running the script with the <em>Quarto</em> running the code from the <a href="#worst-case-latency">Worst-Case Latency</a> section outputs:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#f8f8f2"><span class="token plain">...</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">Send Rate: 15.79 MBaud, Receive Rate: 15.79 MBaud. Got 1638.4 kBytes and received 1638.4 kBytes in 830.08 ms (Loop 196/200)</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">Send Rate: 15.56 MBaud, Receive Rate: 15.56 MBaud. Got 1638.4 kBytes and received 1638.4 kBytes in 842.31 ms (Loop 197/200)</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">Send Rate: 15.46 MBaud, Receive Rate: 15.46 MBaud. Got 1638.4 kBytes and received 1638.4 kBytes in 847.92 ms (Loop 198/200)</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">Send Rate: 15.68 MBaud, Receive Rate: 15.68 MBaud. Got 1638.4 kBytes and received 1638.4 kBytes in 835.76 ms (Loop 199/200)</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">Send Rate: 15.67 MBaud, Receive Rate: 15.67 MBaud. Got 1638.4 kBytes and received 1638.4 kBytes in 836.39 ms (Loop 200/200)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/Quarto/AppNotes/AnalogResponseTime"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Analog Response Time</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/Quarto/Compliance"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Compliance</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#trigger-interrupt-latency" class="table-of-contents__link toc-highlight">Trigger Interrupt Latency</a></li><li><a href="#latency-under-load" class="table-of-contents__link toc-highlight">Latency Under Load</a></li><li><a href="#worst-case-latency" class="table-of-contents__link toc-highlight">Worst-Case Latency</a></li><li><a href="#footnotes" class="table-of-contents__link toc-highlight">Footnotes</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title"></div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/Privacy">Privacy Policy</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">368 Ontario St, Toronto ON, M5A 2V7 | Ontario, Canada | Phone: (720)-741-1556 <br> Copyright © 2022 <div class="baloo">qNimble</div></div></div></div></footer></div>
<script src="/assets/js/runtime~main.0d03e401.js"></script>
<script src="/assets/js/main.f554445b.js"></script>
</body>
</html>