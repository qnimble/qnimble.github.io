<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.0">
<meta name="robots" content="noindex, nofollow">
<link rel="alternate" type="application/rss+xml" href="/News/rss.xml" title="qNimble Quarto Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/News/atom.xml" title="qNimble Quarto Blog Atom Feed">
<script src="https://getinsights.io/js/insights.js" defer="defer" onload='insights.init("nJ5SrJEyZ3crqT00"),insights.trackPages()'></script>
<script src="https://js.qnimble.com/js/index.js" async defer="defer" data-domain="dev.qnimble.com"></script><title data-react-helmet="true">MeasureLatency | qNimble Quarto</title><meta data-react-helmet="true" property="og:url" content="https://qnimble.com/Quarto/AppNotes/MeasureLatency"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-quarto-current"><meta data-react-helmet="true" property="og:title" content="MeasureLatency | qNimble Quarto"><meta data-react-helmet="true" name="description" content="---"><meta data-react-helmet="true" property="og:description" content="---"><link data-react-helmet="true" rel="shortcut icon" href="/img/profile-256.png"><link data-react-helmet="true" rel="canonical" href="https://qnimble.com/Quarto/AppNotes/MeasureLatency"><link data-react-helmet="true" rel="alternate" href="https://qnimble.com/Quarto/AppNotes/MeasureLatency" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://qnimble.com/Quarto/AppNotes/MeasureLatency" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.3ae5a183.css">
<link rel="preload" href="/assets/js/runtime~main.7fd4f00b.js" as="script">
<link rel="preload" href="/assets/js/main.cf2f537e.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="qNimble" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="qNimble" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">qNimble</strong></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/Quarto">Quarto</a><a class="navbar__item navbar__link" href="/Contact">Contact</a><a class="navbar__item navbar__link" href="/News">News</a><a class="navbar__item navbar__link" href="/Store">Store</a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="qNimble" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="qNimble" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">qNimble</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/Quarto">Quarto</a></li><li class="menu__list-item"><a class="menu__link" href="/Contact">Contact</a></li><li class="menu__list-item"><a class="menu__link" href="/News">News</a></li><li class="menu__list-item"><a class="menu__link" href="/Store">Store</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/Quarto/">Overview</a></li><li class="menu__list-item"><a class="menu__link" href="/Quarto/Specifications">Specifications</a></li><li class="menu__list-item"><a class="menu__link" href="/Quarto/Quick_Start">Quick Start Guide</a></li><li class="menu__list-item"><a class="menu__link" href="/Quarto/FAQ">Frequently Asked Questions</a></li><li class="menu__list-item"><a class="menu__link" href="/Quarto/Troubleshooting">Troubleshooting Guide</a></li><li class="menu__list-item"><a class="menu__link menuLinkText_2aKo">Examples</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Examples/Servo">PID Servo</a></li></ul></li><li class="menu__list-item"><a class="menu__link menuLinkText_2aKo">Software Functions</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Software/ADC">ADC</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Software/DAC">DAC</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Software/Digital">Digital I/O</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Software/Triggers">Triggers</a></li></ul></li><li class="menu__list-item"><a class="menu__link menuLinkText_2aKo">App Notes</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/Quarto/AppNotes/MeasureLatency">MeasureLatency</a></li></ul></li></ul></div><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_1CGd"><svg width="20" height="20" role="img" class="collapseSidebarButtonIcon_3E-R"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">MeasureLatency</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="import-empty-from-srclibformatjs"></a>import {Empty} from &#x27;../../src/lib/format.js&#x27;<a class="hash-link" href="#import-empty-from-srclibformatjs" title="Direct link to heading">#</a></h2><p>title: Measuring Response Time</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="hide_title-true"></a>hide_title: true<a class="hash-link" href="#hide_title-true" title="Direct link to heading">#</a></h2><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="measuring-response-time-latency--jitter"></a>Measuring Response Time (Latency &amp; Jitter)<a class="hash-link" href="#measuring-response-time-latency--jitter" title="Direct link to heading">#</a></h1><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="overview"></a>Overview<a class="hash-link" href="#overview" title="Direct link to heading">#</a></h2><p>Whenever you want to micro-controller unit (MCU) to stop what it is doing to handle something else, an interrupt is needed to preempt the current task the MCU is executing.  When new ADC data is ready, we use an interrupt to process that new data. Similarly when the USB has incoming data, an interrupt will fire so the MCU can switch to handling the new USB data.  Interrupts enable a processor to juggle multiple tasks while still responding quickly to important events. </p><p>There are numerous reasons an processor will not respond as quickly to an interrupt as one would like. Many processors use instruction pipelining and caching, and these features reduce the processor&#x27;s ability to quickly run different instructions. Also, processors usually have to spend time storing the working memory of their current task before they can respond to an interrupt. Additionally, some processors need to spend time determining which interrupt fired before the they can respond appropriately. And finally, the software the processor is running can limit the response time by, for example, disabling listening to any interrupts for a period of time. </p><p>In this application note, we will measure the time it takes for the <em>Quarto</em> to respond to an interrupt (often called the interrupt latency).  In order to support quick response times and high servo bandwidth, the <em>Quarto</em> has been designed to have very low interrupt latency. </p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Interrupt Priority</h5></div><div class="admonition-content"><p>In this application note, we will assume that the interrupt we care about is running at the highest priority. If you have multiple interrupts firing then anything with a lower priority will be delayed until the higher priority interrupt finishes. In such a situation, the interrupt latency becomes much more complex for low-priority interrupts.</p></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="trigger-interrupt-latency"></a>Trigger Interrupt Latency<a class="hash-link" href="#trigger-interrupt-latency" title="Direct link to heading">#</a></h2><p>In this example, we will measure the interrupt latency from an external trigger, although the data would look the same for new ADC data as well. Here is basic code for configuring an interrupt to execute the function <code>gotTrigger</code> on the rising edge of Trigger 1.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c"><div tabindex="0" class="prism-code language-c codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#f8f8f2;background-color:#272822"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">setup</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain">  </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">setTrigger2Direction</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">PIN_DIRECTION_OUTPUT</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Use Trigger 2 as output</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">enableInterruptTrigger1</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">true</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> gotTrigger</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Run gotTrigger on Trigger 1 rising edge</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">gotTrigger</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">void</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">setTrigger2High</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Set Trigger 2 to go high so when know when function begins to run</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">delayNanoseconds</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">100</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Function runs too fast to see Trigger 2 pulse on O-scope otherwise</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">setTrigger2Low</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Set Trigger 2 go to low when function completes</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>An oscilloscope is configured to display with 10s of persistence so we can see multiple trigger responses on the same screen. The cyan trace shows the Trigger 1 input and yellow shows Trigger 2.</p><img class="center" src="/img/isr-latency-p1.png"><p>The Trigger 2 goes high about 110ns after the Trigger 1 goes high. So the Interrupt Latency is approximately 110ns. The <code>gotTrigger()</code> function finishes executing about 90ns later. Because of the persistence setup on the oscilloscope, the yellow trace is broadened by the timing jitter, as sometimes the response is a little faster or slower. But this is on the order of only 10ns. </p><p>While 110ns latency is terrific, this is under ideal circumstances as we will see in the next section.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="latency-under-load"></a>Latency Under Load<a class="hash-link" href="#latency-under-load" title="Direct link to heading">#</a></h2><p>The previous code generated a nice baseline, however, the MCU was never doing anything except handling the Trigger 1 interrupt, so it was in an ideal position to respond quickly. Realistically, the MCU will be busy handling USB data and doing other tasks in the main loop. This will add jitter to the latency as sometimes the MCU is idle and sometimes it has to store what it is working on to memory before it can respond to the interrupt. To model this better, we&#x27;ve added a new loop function that the MCU continuously runs. In the loop, we will do a few things:</p><ul><li>USB: echo back any USB data that is received</li><li>Math: Do a math calculation all the time in the loop function</li><li>LED: Toggle the front panel LED every 500ms</li></ul><p>The new code is:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c"><div tabindex="0" class="prism-code language-c codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#f8f8f2;background-color:#272822"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">setup</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain">  </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">setTrigger2Direction</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">PIN_DIRECTION_OUTPUT</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Use Trigger 2 as output</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">enableInterruptTrigger1</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">true</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> gotTrigger</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Run gotTrigger on Trigger 1 rising edge</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">gotTrigger</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">void</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain">  </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">setTrigger2High</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Set Trigger 2 to go high so when know when function begins to run</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">delayNanoseconds</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">100</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Function runs too fast to see Trigger 2 pulse on O-scope otherwise  </span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">setTrigger2Low</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Set Trigger 2 go to low when function completes</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">loop</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">long</span><span class="token plain"> lastrun</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">signed</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">long</span><span class="token plain"> total</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token function" style="color:#e6db74">millis</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token plain"> lastrun </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">500</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//Run once every 500ms            </span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token function" style="color:#e6db74">toggleLEDGreen</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//toggle green LED;            </span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    lastrun </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> lastrun </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">500</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  total </span><span class="token operator" style="color:#66d9ef">+=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">324</span><span class="token operator" style="color:#66d9ef">*</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">total</span><span class="token operator" style="color:#66d9ef">-</span><span class="token number" style="color:#ae81ff">2343</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//do some math in main loop</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">char</span><span class="token plain"> dat</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">Serial</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">available</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    dat </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> Serial</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">read</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//Read USB data if available</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    Serial</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">print</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">dat</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//Echo data back over USB</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain">  </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>An external function generator was used to have Trigger 1 go from low to high once every 1μs (frequency of 1 MHz) and a python script was used to stream data in and out of the <em>Quarto</em> (18 Mbps down, 18 Mbps up). While all this was happening , let&#x27;s look at the response time again with the oscilloscope still set at 10s persistence: </p><img class="center" src="/img/isr-latency-p2.png"><p>The response it still usually about 110ns, however, over the 10s oscilloscope window, we can see there are numerous events where the latency is higher. Especially when using the <em>Quarto</em> for servoing, the consistency of the response time is just as important as the response time is itself. In the worst case, Trigger 2 falls 275ns after the rising edge of Trigger 1. That 275ns includes the interrupt latency, the function execution time and the maximum timing jitter.  With the minimal latency of 110ns and the function taking 90ns to run, the jitter is the remainder: 275ns - 110ns -90ns = 75ns. So the interrupt latency varies between 110ns and 185ns. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="worst-case-latency"></a>Worst-Case Latency<a class="hash-link" href="#worst-case-latency" title="Direct link to heading">#</a></h2><p>There is another limitation on the latency that we haven&#x27;t mentioned: getting data into and out of the floating point unit (FPU). If the main process is doing floating point math (using <code>floats</code> or <code>doubles</code> in C), then it is using the FPU. If an interrupt fires that also needs to do floating point math, then, just like the MCU, the FPU needs to clean up and store what it is working on before it can process the new data. This adds additional jitter to the interrupt latency we measured previously. To test this, we will take our previous code but have both the main loop and the trigger interrupt do math on double precision floats. The new code is below.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c"><div tabindex="0" class="prism-code language-c codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#f8f8f2;background-color:#272822"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">setup</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain">  </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">setTrigger2Direction</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">PIN_DIRECTION_OUTPUT</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Use Trigger 2 as output</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">enableInterruptTrigger1</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">true</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> gotTrigger</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Run gotTrigger on Trigger 1 rising edge</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> DACout </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//global variable used by main loop and gotTrigger</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">gotTrigger</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">void</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain">  </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">setTrigger2High</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Set Trigger 2 to go high so when know when function begins to run</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">writeDAC1</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">DACout</span><span class="token operator" style="color:#66d9ef">*</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">DACout</span><span class="token operator" style="color:#66d9ef">*</span><span class="token number" style="color:#ae81ff">2.342</span><span class="token operator" style="color:#66d9ef">-</span><span class="token number" style="color:#ae81ff">3.232</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//Do some floating point math and then update the DAC with the result</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">delayNanoseconds</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">100</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Function runs too fast to see Trigger 2 pulse on O-scope otherwise  </span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">setTrigger2Low</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Set Trigger 2 to go low when function completes</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">loop</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">long</span><span class="token plain"> lastrun</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">signed</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">long</span><span class="token plain"> total</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token function" style="color:#e6db74">millis</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token plain"> lastrun </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">500</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//Run once every 500ms            </span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token function" style="color:#e6db74">toggleLEDGreen</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//toggle green LED;            </span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    lastrun </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> lastrun </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">500</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  DACout </span><span class="token operator" style="color:#66d9ef">+=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">3.2342</span><span class="token operator" style="color:#66d9ef">*</span><span class="token function" style="color:#e6db74">sin</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">DACout</span><span class="token operator" style="color:#66d9ef">*</span><span class="token number" style="color:#ae81ff">23.234</span><span class="token operator" style="color:#66d9ef">+</span><span class="token number" style="color:#ae81ff">65.324</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//do some FPU math in main loop</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">char</span><span class="token plain"> dat</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">Serial</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">available</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    dat </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> Serial</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">read</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//Read USB data if available</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    Serial</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">print</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">dat</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//Echo data back over USB</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain">  </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>In summary, the <em>Quarto</em> is doing the following:</p><ul><li>Every 1μs, handle external trigger, do floating point math and update the DAC</li><li>Do floating point math in main loop all the time</li><li>Receive USB data at 15 Mbps</li><li>Transmit USB data at 15 Mbps</li></ul><p>In this setup, we get the following latency measurement:</p><img class="center" src="/img/isr-latency-p3.png"><p>The interrupt latency is now rarely at 110ns, but usually closer to 125ns. However, the worst case latency is 210ns. So the interrupt latency varies between 110ns and 210ns and the maximum jitter is now 100ns (before it was 75ns). Additionally, the <code>gotTrigger</code> function now takes 160ns as it is doing math and updating the DAC in addition to the 100ns delay we programmed in. The <code>gotTrigger</code> function sometimes finishes as late as 370ns after the trigger fired, which is consistent with 110ns latency + 100 ns jitter + 160ns execution time.  Even when pushing the <em>Quarto</em> to its limits, the interrupt latency is bounded to be under about 210ns.</p><p>For a 100 kHz PID Servo, the total loop delay is 5us (180° phase shift at 100kHz),  so 100ns of timing jitter is only 2% timing variation, a small effect. Having consistent and bounded interrupt latency is crucial for consistent loop bandwidths and response times.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="footnotes"></a>Footnotes<a class="hash-link" href="#footnotes" title="Direct link to heading">#</a></h2><p>To generate the data presented above, the following python script was used to stream data to and from the <em>Quarto</em>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><div tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#f8f8f2;background-color:#272822"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">import</span><span class="token plain"> serial</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">time</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">os</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">ser </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> serial</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Serial</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&#x27;COM4&#x27;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">packets </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">400</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">loops </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">200</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">packetSizeSend </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">64</span><span class="token operator" style="color:#66d9ef">*</span><span class="token number" style="color:#ae81ff">64</span><span class="token plain"> </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">packetSizeReceive </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> packetSizeSend</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">loop</span><span class="token operator" style="color:#66d9ef">=</span><span class="token number" style="color:#ae81ff">0</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">for</span><span class="token plain"> empty </span><span class="token keyword" style="color:#66d9ef">in</span><span class="token plain"> </span><span class="token builtin" style="color:#e6db74">range</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">loops</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    loop </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> loop </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">1</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    start</span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain">time</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">time</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#66d9ef">in</span><span class="token plain"> </span><span class="token builtin" style="color:#e6db74">range</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">packets</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        byte </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">urandom</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">packetSizeSend</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        ser</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">write</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">byte</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        data</span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain">ser</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">read</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">packetSizeReceive</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> byte </span><span class="token operator" style="color:#66d9ef">!=</span><span class="token plain"> data</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">print</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&#x27;Error: Return data does not match. Length = {} and {}&#x27;</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token builtin" style="color:#e6db74">format</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token builtin" style="color:#e6db74">len</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">byte</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token builtin" style="color:#e6db74">len</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    stop</span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain">time</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">time</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    rescaleSend </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">8</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">packetSizeSend</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">packets</span><span class="token operator" style="color:#66d9ef">/</span><span class="token number" style="color:#ae81ff">1000000.0</span><span class="token operator" style="color:#66d9ef">/</span><span class="token builtin" style="color:#e6db74">max</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">.000001</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">stop</span><span class="token operator" style="color:#66d9ef">-</span><span class="token plain">start</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    rescaleReceive </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">8</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">packetSizeReceive</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">packets</span><span class="token operator" style="color:#66d9ef">/</span><span class="token number" style="color:#ae81ff">1000000.0</span><span class="token operator" style="color:#66d9ef">/</span><span class="token builtin" style="color:#e6db74">max</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">.000001</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">stop</span><span class="token operator" style="color:#66d9ef">-</span><span class="token plain">start</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">print</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&#x27;Send Rate: {:0.2f} MBaud, Receive Rate: {:0.2f} MBaud. Got {} kBytes and received {} kBytes in {:0.2f} ms (Loop {}/{})&#x27;</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token builtin" style="color:#e6db74">format</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">rescaleSend</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">rescaleReceive</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">packets</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">packetSizeSend</span><span class="token operator" style="color:#66d9ef">/</span><span class="token number" style="color:#ae81ff">1000</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">packets</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">packetSizeReceive</span><span class="token operator" style="color:#66d9ef">/</span><span class="token number" style="color:#ae81ff">1000</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">stop</span><span class="token operator" style="color:#66d9ef">-</span><span class="token plain">start</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token operator" style="color:#66d9ef">*</span><span class="token number" style="color:#ae81ff">1000</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">loop</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">loops</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">del</span><span class="token plain"> ser</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Running the script with the <em>Quarto</em> running the code from the <a href="#worst-case-latency">Worst-Case Latency</a> section outputs:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#f8f8f2;background-color:#272822"><div class="token-line" style="color:#f8f8f2"><span class="token plain">...</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">Send Rate: 15.79 MBaud, Receive Rate: 15.79 MBaud. Got 1638.4 kBytes and received 1638.4 kBytes in 830.08 ms (Loop 196/200)</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">Send Rate: 15.56 MBaud, Receive Rate: 15.56 MBaud. Got 1638.4 kBytes and received 1638.4 kBytes in 842.31 ms (Loop 197/200)</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">Send Rate: 15.46 MBaud, Receive Rate: 15.46 MBaud. Got 1638.4 kBytes and received 1638.4 kBytes in 847.92 ms (Loop 198/200)</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">Send Rate: 15.68 MBaud, Receive Rate: 15.68 MBaud. Got 1638.4 kBytes and received 1638.4 kBytes in 835.76 ms (Loop 199/200)</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">Send Rate: 15.67 MBaud, Receive Rate: 15.67 MBaud. Got 1638.4 kBytes and received 1638.4 kBytes in 836.39 ms (Loop 200/200)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></div></article><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/Quarto/Software/Triggers"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Triggers</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#import-empty-from-srclibformatjs" class="table-of-contents__link">import {Empty} from &#39;../../src/lib/format.js&#39;</a></li><li><a href="#hide_title-true" class="table-of-contents__link">hide_title: true</a></li><li><a href="#overview" class="table-of-contents__link">Overview</a></li><li><a href="#trigger-interrupt-latency" class="table-of-contents__link">Trigger Interrupt Latency</a></li><li><a href="#latency-under-load" class="table-of-contents__link">Latency Under Load</a></li><li><a href="#worst-case-latency" class="table-of-contents__link">Worst-Case Latency</a></li><li><a href="#footnotes" class="table-of-contents__link">Footnotes</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/Privacy">Privacy Policy</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 <div class="baloo">qNimble</div></div></div></div></footer></div>
<script src="/assets/js/runtime~main.7fd4f00b.js"></script>
<script src="/assets/js/main.cf2f537e.js"></script>
</body>
</html>