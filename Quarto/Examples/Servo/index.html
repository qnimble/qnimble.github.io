<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.71">
<link rel="alternate" type="application/rss+xml" href="/News/rss.xml" title="qNimble Quarto Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/News/atom.xml" title="qNimble Quarto Blog Atom Feed">
<script src="https://getinsights.io/js/insights.js" defer="defer" onload='insights.init("nJ5SrJEyZ3crqT00"),insights.trackPages()'></script><title data-react-helmet="true">PID Servo | qNimble Quarto</title><meta data-react-helmet="true" property="og:url" content="https://docs.qnimble.com/Quarto/Examples/Servo"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-quarto-current"><meta data-react-helmet="true" property="og:title" content="PID Servo | qNimble Quarto"><meta data-react-helmet="true" name="description" content="The Quarto can turn into a proportional-integral-differential (PID) Servo with just 20 lines of code! Let&#x27;s see how."><meta data-react-helmet="true" property="og:description" content="The Quarto can turn into a proportional-integral-differential (PID) Servo with just 20 lines of code! Let&#x27;s see how."><link data-react-helmet="true" rel="shortcut icon" href="/img/profile-256.png"><link data-react-helmet="true" rel="canonical" href="https://docs.qnimble.com/Quarto/Examples/Servo"><link data-react-helmet="true" rel="alternate" href="https://docs.qnimble.com/Quarto/Examples/Servo" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://docs.qnimble.com/Quarto/Examples/Servo" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.6d54aa39.css">
<link rel="preload" href="/assets/js/styles.e0f1a698.js" as="script">
<link rel="preload" href="/assets/js/runtime~main.1e9fdff5.js" as="script">
<link rel="preload" href="/assets/js/main.c8649cb4.js" as="script">
<link rel="preload" href="/assets/js/common.a4684383.js" as="script">
<link rel="preload" href="/assets/js/2.75c98d91.js" as="script">
<link rel="preload" href="/assets/js/34.148373b5.js" as="script">
<link rel="preload" href="/assets/js/35.d95b2c02.js" as="script">
<link rel="preload" href="/assets/js/7876c7ae.dcc4ccf2.js" as="script">
<link rel="preload" href="/assets/js/17896441.41b0a79f.js" as="script">
<link rel="preload" href="/assets/js/655f0e29.b92280ab.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="qNimble" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="qNimble" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">qNimble</strong></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/Quarto/">Quarto</a><a class="navbar__item navbar__link" href="/Contact/">Contact</a><a class="navbar__item navbar__link" href="/News">News</a><a class="navbar__item navbar__link" href="/Store/">Store</a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="qNimble" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="qNimble" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">qNimble</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/Quarto/">Quarto</a></li><li class="menu__list-item"><a class="menu__link" href="/Contact/">Contact</a></li><li class="menu__list-item"><a class="menu__link" href="/News">News</a></li><li class="menu__list-item"><a class="menu__link" href="/Store/">Store</a></li></ul></div></div></div></nav><div class="main-wrapper main-docs-wrapper"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/Quarto/">Overview</a></li><li class="menu__list-item"><a class="menu__link" href="/Quarto/Specifications">Specifications</a></li><li class="menu__list-item"><a class="menu__link" href="/Quarto/Quick_Start">Quick Start Guide</a></li><li class="menu__list-item"><a class="menu__link" href="/Quarto/FAQ">Frequently Asked Questions</a></li><li class="menu__list-item"><a class="menu__link menuLinkText_2aKo">Examples</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/Quarto/Examples/Servo">PID Servo</a></li></ul></li><li class="menu__list-item"><a class="menu__link menuLinkText_2aKo">Software Functions</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Software/ADC">ADC</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Software/DAC">DAC</a></li></ul></li></ul></div><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_1CGd"><svg width="20" height="20" role="img" class="collapseSidebarButtonIcon_3E-R"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">PID Servo</h1></header><div class="markdown"><p>The <em>Quarto</em> can turn into a proportional-integral-differential (PID) Servo with just 20 lines of code! Let&#x27;s see how.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="setup"></a>Setup<a class="hash-link" href="#setup" title="Direct link to heading">#</a></h2><p>The setup function is run once at start-up and is used to configure the ADC. For the servo, we want use ADC channel 1, so we use the function configureADC1 to configure it. We want the  ADC to fire every 1µs and to have a voltage range of ±1.25V.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c"><div tabindex="0" class="prism-code language-c codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#f8f8f2;background-color:#272822"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">setup</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">void</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain">  </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">configureADC1</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">BIPOLAR_1250mV</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">getADC1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Have ADC take measurement every 1us, ±1.25V range</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>With the Arduino 2.0 IDE, if we hover over the function configureADC1, a window pops up showing the function arguments:</p><p><img alt="img" src="/assets/images/arduino2-adc-config-s1-6e4178aed79cb86c850f9c4dd8fe88b0.png"></p><p>First argument, <code>fire_every_us</code> tells the ADC how often to fire. In this example, we want to run the ADC at its maximum rate of 1MSPS (1 Mega Samples Per Second) so we fire every 1us, so we set this parameter to one. If we wanted to sample every 5us (or 200 kHz sample rate), this should be set to 5.</p><p>The second argument, <code>fire_delay</code> delays when the ADC fires. This has no real meaning when only using one ADC channel, but if you configure multiple ADC channels, to control the timing relationship between different channels. </p><p>The next argument, <code>scale</code> sets the ADC voltage range. Valid inputs are <code>BIPOLAR_1250mV</code> <code>BIPOLAR_2500mV</code>, <code>BIPOLAR_5V</code> and <code>BIPOLAR_10V</code>. In this case, we want the ADC range to be ±1.25V, so we set it to <code>BIPOLAR_1250mV</code> .</p><p>Finally, the last argument, <code>function</code> is the function to call when there is ADC data. We will call this function <code>getADC1</code> although the name does not matter.</p><p>We will also define a setpoint which is the target value we want to see at the ADC input. We will use a macro to do this so if we want to change the setpoint, we only have to change the value in one place. For this example, we will have the <code>SETPOINT</code> equal to 0.25</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c"><div tabindex="0" class="prism-code language-c codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#f8f8f2;background-color:#272822"><div class="token-line" style="color:#f8f8f2"><span class="token macro property directive-hash" style="color:#f92672">#</span><span class="token macro property directive keyword" style="color:#66d9ef">define</span><span class="token macro property" style="color:#f92672"> </span><span class="token macro property macro-name" style="color:#f92672">SETPOINT</span><span class="token macro property" style="color:#f92672"> </span><span class="token macro property expression number" style="color:#ae81ff">0.25</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="function-when-adc-data-is-available"></a>Function when ADC Data is Available<a class="hash-link" href="#function-when-adc-data-is-available" title="Direct link to heading">#</a></h2><p>We now need to define the function that is called when the ADC gets data. On our case this function is called <code>getADC</code>. Here&#x27;s the code for that function:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c"><div tabindex="0" class="prism-code language-c codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#f8f8f2;background-color:#272822"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">getADC1</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">void</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> integral </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> prev_adc </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> newadc </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">readADC1_from_ISR</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//read ADC voltage</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> prop </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">newadc</span><span class="token operator" style="color:#66d9ef">-</span><span class="token plain">SETPOINT</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">1.975</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//proportional</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  integral </span><span class="token operator" style="color:#66d9ef">+=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">newadc </span><span class="token operator" style="color:#66d9ef">-</span><span class="token plain"> SETPOINT</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0.01</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// integral gain</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> diff </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"> newadc </span><span class="token operator" style="color:#66d9ef">-</span><span class="token plain"> prev_adc</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0.00001</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// turn diff down for accuracate BW measurement</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> newdac </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> prop </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> integral </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> diff</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">writeDAC1</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#66d9ef">-</span><span class="token plain">newdac</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//invert for negative feedback  </span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  prev_adc </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> newadc</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//store new adc value for differential calculation</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The first two lines of the function define two double-precision floating point numbers <code>integral</code> and <code>prev_adc</code>. These two definitions start with static which means that these variables do not disappear after the function runs, but they are kept for subsequent runs. So for the first run, <code>integral</code> and <code>prev_adc</code> start at 0. If at the end of the first run, <code>integral</code> is 1.2345, then <code>integral</code> will start with that value for the next run, and so on.</p><p>The next line reads the ADC1 value and stores it into the double <code>newadc</code>. </p><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>Make sure to call readADCX_from_ISR()!!</h5></div><div class="admonition-content"><p>Any function that runs when new ADC data is available  must execute the function readADCX_from_ISR()!</p></div></div><p>When the ADC has new data, it fires an interrupt. That interrupt executes the function configured in configureADCX and that function must clear the interrupt, which is done by running readADCX_from_ISR(). Otherwise the function will loop forever and the Quarto will crash. </p><p>The next set of commands calculate the proportional, integral and differential (PID) values. The proportional value is the difference between the ADC value (<code>newadc</code>) and the SETPOINT, multiplied by a scale constant, in this case 1.975. The integral calculation is similar, but with a different scale constant (0.01) and we use a <code>+=</code> instead of an <code>=</code> to assign it a value so it sums the new calculation with the previous value of <code>integral</code>. Next, the differential looks at the difference between the current ADC value (<code>newadc</code>) and the previously measured ADC value (<code>prev_adc</code>) and multiplies that by the scale constant (0.00001). Finally, we sum these two values together in the new value <code>newdac</code>.</p><p>The second to last line of the function writes the newly calculated PID value to the channel 1 DAC using the <code>writeDAC1</code> command. There is a minus sign in front of the argument <code>newdac</code> to invert the value, which we need to do to provide negative feedback. </p><p>The last line stores the most recent ADC measurement (<code>newadc</code>) in the variable <code>prev_adc</code> for use the next time this function is run.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="final-code"></a>Final Code<a class="hash-link" href="#final-code" title="Direct link to heading">#</a></h2><p>Putting this altogether, we have:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c"><div tabindex="0" class="prism-code language-c codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#f8f8f2;background-color:#272822"><div class="token-line" style="color:#f8f8f2"><span class="token macro property directive-hash" style="color:#f92672">#</span><span class="token macro property directive keyword" style="color:#66d9ef">define</span><span class="token macro property" style="color:#f92672"> </span><span class="token macro property macro-name" style="color:#f92672">SETPOINT</span><span class="token macro property" style="color:#f92672"> </span><span class="token macro property expression number" style="color:#ae81ff">0.25</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">setup</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">void</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain">  </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">configureADC1</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">BIPOLAR_1250mV</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">getADC1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Have ADC take measurement every 1us, ±1.25V range</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">getADC1</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">void</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> integral </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> prev_adc </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> newadc </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">readADC1_from_ISR</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//read ADC voltage</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> prop </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">newadc</span><span class="token operator" style="color:#66d9ef">-</span><span class="token plain">SETPOINT</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">1.975</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//proportional</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  integral </span><span class="token operator" style="color:#66d9ef">+=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">newadc </span><span class="token operator" style="color:#66d9ef">-</span><span class="token plain"> SETPOINT</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0.01</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// integral gain</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> diff </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"> newadc </span><span class="token operator" style="color:#66d9ef">-</span><span class="token plain"> prev_adc</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0.00001</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// turn diff down for accuracate BW measurement</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> newdac </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> prop </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> integral </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> diff</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">writeDAC1</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#66d9ef">-</span><span class="token plain">newdac</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//invert for negative feedback  </span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  prev_adc </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> newadc</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//store new adc value for differential calculation</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="data"></a>Data<a class="hash-link" href="#data" title="Direct link to heading">#</a></h2><p>Using this code, if you connect the channel 1 DAC output to the ADC channel 1 input, the Quarto can lock to itself and it will oscillate at over 100 kHz, as shown below. (Just lower the proportional gain scalar from 1.975 to stop the oscillation)</p><p><img alt="img" src="/assets/images/SimplePIDServo-s1-1893b5293796035a912ee97bed24e576.png"></p></div></article><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/Quarto/FAQ"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Frequently Asked Questions</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/Quarto/Software/ADC"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">ADC »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#setup" class="table-of-contents__link">Setup</a></li><li><a href="#function-when-adc-data-is-available" class="table-of-contents__link">Function when ADC Data is Available</a></li><li><a href="#final-code" class="table-of-contents__link">Final Code</a></li><li><a href="#data" class="table-of-contents__link">Data</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/privacy">Privacy Policy</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 <div class="baloo">qNimble</div></div></div></div></footer></div>
<script src="/assets/js/styles.e0f1a698.js"></script>
<script src="/assets/js/runtime~main.1e9fdff5.js"></script>
<script src="/assets/js/main.c8649cb4.js"></script>
<script src="/assets/js/common.a4684383.js"></script>
<script src="/assets/js/2.75c98d91.js"></script>
<script src="/assets/js/34.148373b5.js"></script>
<script src="/assets/js/35.d95b2c02.js"></script>
<script src="/assets/js/7876c7ae.dcc4ccf2.js"></script>
<script src="/assets/js/17896441.41b0a79f.js"></script>
<script src="/assets/js/655f0e29.b92280ab.js"></script>
</body>
</html>