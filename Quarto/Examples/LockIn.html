<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-quarto docs-doc-id-Examples/LockIn">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Lock-in Amplifier | qNimble Quarto</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="robots" content="noindex, nofollow"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://qnimble.com/img/quarto-frontpanel.jpg"><meta data-rh="true" name="twitter:image" content="https://qnimble.com/img/quarto-frontpanel.jpg"><meta data-rh="true" property="og:url" content="https://qnimble.com/Quarto/Examples/LockIn"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-quarto-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-quarto-current"><meta data-rh="true" property="og:title" content="Lock-in Amplifier | qNimble Quarto"><meta data-rh="true" name="description" content="Example for using the Quarto as a Lock-In Amplifer"><meta data-rh="true" property="og:description" content="Example for using the Quarto as a Lock-In Amplifer"><meta data-rh="true" name="keywords" content="Lock-In,PDH,Pound-Drevel-Hall,Frequency Modulation"><link data-rh="true" rel="icon" href="/img/profile-256.png"><link data-rh="true" rel="canonical" href="https://qnimble.com/Quarto/Examples/LockIn"><link data-rh="true" rel="alternate" href="https://qnimble.com/Quarto/Examples/LockIn" hreflang="en"><link data-rh="true" rel="alternate" href="https://qnimble.com/Quarto/Examples/LockIn" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://JM56V1ZGSL-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/News/rss.xml" title="qNimble RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/News/atom.xml" title="qNimble Atom Feed">
<link rel="alternate" type="application/json" href="/News/feed.json" title="qNimble JSON Feed">



<link rel="search" type="application/opensearchdescription+xml" title="qNimble Quarto" href="/opensearch.xml">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous">
<script src="https://js.qnimble.com/js/index.js" async defer="defer" data-domain="dev.qnimble.com" data-api="https://js.qnimble.com/qvbt/api/event"></script><link rel="stylesheet" href="/assets/css/styles.35c2773a.css">
<link rel="preload" href="/assets/js/runtime~main.41bc4f4f.js" as="script">
<link rel="preload" href="/assets/js/main.3666540f.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="qNimble" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="qNimble" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">qNimble</b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/Quarto">Quarto</a><a class="navbar__item navbar__link" href="/Contact">Contact</a><a class="navbar__item navbar__link" href="/News">News</a><a class="navbar__item navbar__link" href="/Orders">Orders</a><a href="https://forum.qnimble.com" target="_target" rel="noopener noreferrer" class="navbar__item navbar__link">Forum<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Quarto">Quarto</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Quarto/Specifications">Specifications</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Quarto/Quick_Start">Quick Start Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Quarto/FAQ">Frequently Asked Questions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Quarto/Troubleshooting">Troubleshooting Guide</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active" href="/Quarto/Examples">Program Examples</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Examples/Filter">Analog Filter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/Quarto/Examples/LockIn">Lock-in Amplifier</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Examples/Servo">PID Servo</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Examples/Pulsed_Output">Pulsed Output Waveform</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Examples/SDCard">SD Card</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Examples/Threads">Threading</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Examples/Commands">Serial Commands</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link" href="/Quarto/Functions">Software Functions</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Functions/ADC">ADC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Functions/DAC">DAC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Functions/Digital">Digital I/O</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Functions/ExternalClocks">External Clocks</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Functions/LEDs">LEDs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Functions/Memory">Memory</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/Functions/Triggers">Triggers</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link" href="/Quarto/AppNotes">App Notes</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/AppNotes/ADCTiming">ADC Timing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/AppNotes/AnalogResponseTime">Response Time &amp; Servo BW</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/AppNotes/DoubleVsFloat">Doubles vs Floats</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Quarto/AppNotes/InterruptLatency">Measuring Interrupt Latency</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Quarto/Compliance">Compliance</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Lock-in Amplifier</h1></header><p>This example will show how to use the <em>Quarto</em> as a lock-in amplifier. </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="generate-reference">Generate Reference<a href="#generate-reference" class="hash-link" aria-label="Direct link to Generate Reference" title="Direct link to Generate Reference">​</a></h2><p>We will use the ADC sampling rate as the &#x27;heartbeat&#x27; to control the timing of the full system. The first step is to configure ADC channel 1 to collect data every 2µs with a voltage range of ±10V (see <a href="/Quarto/Examples/Servo">PID Servo</a> for more details on this setup). The function <code>getADC1</code> will run when there is new ADC data (every 2µs) and in that function we will update DAC channel 1 to generate a sine-wave output.</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> uint SampleRate </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">2</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> frequency </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">10e3</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> amplitude </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">5.0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">setup</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">void</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">configureADC</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">SampleRate</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">BIPOLAR_10V</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">getADC1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Have ADC take measurement every 2us, ±10V range</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">getADC1</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">void</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> cycle </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//track phase/(2*pi) which is cycle fraction (one cycle=2pi). </span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> newadc </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">readADC1_from_ISR</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//read ADC voltage</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  cycle </span><span class="token operator" style="color:#66d9ef">+=</span><span class="token plain"> frequency </span><span class="token operator" style="color:#66d9ef">/</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">1e6</span><span class="token operator" style="color:#66d9ef">/</span><span class="token plain">SampleRate</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//1e6/SampleRate is sample freq (500kHz);  freq normed to that</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">writeDAC</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">amplitude</span><span class="token operator" style="color:#66d9ef">*</span><span class="token function" style="color:#e6db74">sin</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">2</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">PI</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">cycle</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//DAC output is sin(2*pi*cycle) </span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">cycle </span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> cycle </span><span class="token operator" style="color:#66d9ef">-=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//reset phase so no overflows</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Everytime the ADC gets a new datapoint, we increment the phase and take the sine of that phase to get the desired DAC output. Mathematically we track <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>phase</mtext><mi mathvariant="normal">/</mi><mrow><mn>2</mn><mi>π</mi></mrow></mrow><annotation encoding="application/x-tex">{\text{phase}/{2\pi}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord"><span class="mord text"><span class="mord">phase</span></span><span class="mord">/</span><span class="mord"><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.03588em">π</span></span></span></span></span></span></span> instead of phase so the phase-resets do not have rounding errors from the <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>π</mi></mrow><annotation encoding="application/x-tex">2\pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em"></span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.03588em">π</span></span></span></span></span>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="demodulate">Demodulate<a href="#demodulate" class="hash-link" aria-label="Direct link to Demodulate" title="Direct link to Demodulate">​</a></h2><p>At the heart of a lock-in amplifier is a multiplier. By multiplying the input signal by the reference signal, the component of the input signal at the reference frequency gets moved to DC, where it can be measured more directly. In analog circuits, this is done with a mixer, but with <em>Quarto</em> we can just multiply the digitized signals:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> multiplied </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> newadc </span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">sin</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">2</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">PI</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">cycle</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can then output that new signal on Analog Output #2 (DAC2):</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> uint SampleRate </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">2</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> frequency </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">10e3</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> phase </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> amplitude </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">5.0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">setup</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">void</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">configureADC</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">SampleRate</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">BIPOLAR_10V</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">getADC1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Have ADC take measurement every 2us, ±10V range</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">getADC1</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">void</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> cycle </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//track phase/(2*pi) which is cycle fraction (one cycle=2pi). </span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> newadc </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">readADC1_from_ISR</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//read ADC voltage</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  cycle </span><span class="token operator" style="color:#66d9ef">+=</span><span class="token plain"> frequency </span><span class="token operator" style="color:#66d9ef">/</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">1e6</span><span class="token operator" style="color:#66d9ef">/</span><span class="token plain">SampleRate</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//1e6/SampleRate is sample freq (500kHz); freq normed to that</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">writeDAC</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">amplitude</span><span class="token operator" style="color:#66d9ef">*</span><span class="token function" style="color:#e6db74">sin</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">2</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">PI</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">cycle</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//DAC output is sin(2*pi*cycle) </span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> multiplied </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> newadc </span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">sin</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">2</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">PI</span><span class="token operator" style="color:#66d9ef">*</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">cycle </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> phase</span><span class="token operator" style="color:#66d9ef">/</span><span class="token number" style="color:#ae81ff">360</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">writeDAC</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">2</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">multiplied</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">cycle </span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> cycle </span><span class="token operator" style="color:#66d9ef">-=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//reset phase so no overflows</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="speed-optimization">Speed Optimization<a href="#speed-optimization" class="hash-link" aria-label="Direct link to Speed Optimization" title="Direct link to Speed Optimization">​</a></h3><p>While it does not matter much in this demo, if using the DAC2 output as part of a servo loop, decreasing the latency on the DAC update may be important.  Let&#x27;s look at the sequence of events that happens inside the <code>getADC1</code> function:</p><ol><li>New ADC data comes in</li><li>Update cycle count</li><li>Calculate sine of new cycle count</li><li>Update DAC1 with sine result</li><li>Calculate sine of cycle count plus phase shift</li><li>Update DAC2 with sine result times ADC data</li></ol><p>Calculating the sine is a relatively slow calculation that can often take ~600ns (the time varies based on the input value) so doing two of those calculations will add some delay to the sequence. However, neigher sine calculation uses the ADC data as an argument. This means that we know ahead of time what sine calculations we will need, so we can precalcuate them. This enables us to re-order the calcuation such that the DAC2 update is earlier in the process:</p><ol><li>New ADC data comes in</li><li>Update DAC1 with stored sine result</li><li>Update DAC2 with other stored sine times ADC data</li><li>Update cycle count</li><li>Calculate sine of new cycle count and store</li><li>Calculate sine of new cycle count plus phase shift and store</li></ol><p>All we have done is reorder the operations, but now the delay in changes so the DAC2 output is set only by steps  1 -  3, instead of steps 1 - 6.  Here&#x27;s the updated function <code>getADC1</code> :</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">getADC1</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">void</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> nextSin </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> nextSinWithPhase </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> cycle </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//track phase/(2*pi) which is cycle fraction (one cycle=2pi). </span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> newadc </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">readADC1_from_ISR</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//read ADC voltage</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">writeDAC</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">amplitude</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">nextSin</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//DAC output is sin(2*pi*cycle) </span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> multiplied </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> newadc </span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain"> nextSinWithPhase</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//put phase in units if degrees</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">writeDAC</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">2</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">multiplied</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  cycle </span><span class="token operator" style="color:#66d9ef">+=</span><span class="token plain"> frequency </span><span class="token operator" style="color:#66d9ef">/</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">1e6</span><span class="token operator" style="color:#66d9ef">/</span><span class="token plain">SampleRate</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//1e6/SampleRate is sample freq (500kHz);  freq normed to that</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">cycle </span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> cycle </span><span class="token operator" style="color:#66d9ef">-=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//reset phase so no overflows</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  nextSin </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">sin</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">2</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">PI</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">cycle</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain">      </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  nextSinWithPhase </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">sin</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">2</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">PI</span><span class="token operator" style="color:#66d9ef">*</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">cycle </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> phase</span><span class="token operator" style="color:#66d9ef">/</span><span class="token number" style="color:#ae81ff">360</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This optimization decreases the latency of the <em>Quarto</em>, but does not change how much time is spent processing the data.  If you wanted to do that, one technique would be to set the output frequency to be the ADC rate (or a low multiple of it) divided by an integer. This would make the sine calculations periodic and they could all be calculated once ahead of time and then <code>getADC1</code> could just lookup the right value. The approach shown here however yields good latency and lets the frequency be set arbitrarily.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="data">Data<a href="#data" class="hash-link" aria-label="Direct link to Data" title="Direct link to Data">​</a></h3><p>If you connect the Analog Output #1 to the Analog Input #1 input, then the output on Analog Ouput #2 will be a sine wave at twice the frequency and half the amplitude and a DC offset equal to half the amplitude. This is because of the trig identity:</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>s</mi><mi>i</mi><mi>n</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>∗</mo><mi>s</mi><mi>i</mi><mi>n</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mo fence="false">(</mo><mn>1</mn><mo>−</mo><mi>c</mi><mi>o</mi><mi>s</mi><mo stretchy="false">(</mo><mn>2</mn><mi>x</mi><mo stretchy="false">)</mo><mo fence="false">)</mo></mrow><annotation encoding="application/x-tex">sin(x) * sin(x) = \frac{1}{2} \big(1 - cos(2 x)\big)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="delimsizing size1">(</span></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1.20001em;vertical-align:-0.35001em"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord">2</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mord"><span class="delimsizing size1">)</span></span></span></span></span></span></div><p>The image below shows the Analog Input #1 sine wave (yellow trace) and the multiplied Analog Output #2 (cyan trace):
<img loading="lazy" alt="img" src="/assets/images/LockIn-Oscope-P1-bb870049ea34b9eba1aae7ece35147f2.png" width="800" height="480" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="adjustable-parameters">Adjustable Parameters<a href="#adjustable-parameters" class="hash-link" aria-label="Direct link to Adjustable Parameters" title="Direct link to Adjustable Parameters">​</a></h2><p>In the above example, the output sine wave was fixed at an amplitude of 5V, a frequency of 10 kHz, and the phase shift between the output frequency and the demodulation was also fixed at 0°. We will use the qCommand library to use Serial commands to adjust these parameters (see <a href="/Quarto/Examples/Commands">Serial Commands</a> for more details).  The new code is:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token macro property directive-hash" style="color:#f92672">#</span><span class="token macro property directive keyword" style="color:#66d9ef">include</span><span class="token macro property" style="color:#f92672"> </span><span class="token macro property string" style="color:#a6e22e">&quot;qCommand.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">qCommand qC</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> uint SampleRate </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">2</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> frequency </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">10e3</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> phase </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> amplitude </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">5</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">setup</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">void</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">configureADC</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">SampleRate</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">BIPOLAR_10V</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">getADC1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Have ADC take measurement every 2us, ±10V range</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  qC</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">assignVariable</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;Freq&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token operator" style="color:#66d9ef">&amp;</span><span class="token plain">frequency</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  qC</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">assignVariable</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;Phase&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token operator" style="color:#66d9ef">&amp;</span><span class="token plain">phase</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  qC</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">assignVariable</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;Amp&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token operator" style="color:#66d9ef">&amp;</span><span class="token plain">amplitude</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">loop</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">void</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  qC</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">readSerial</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">Serial</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  qC</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">readSerial</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">Serial2</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">getADC1</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">void</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> nextSin </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> nextSinWithPhase </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> cycle </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//track phase/(2*pi) which is cycle fraction (one cycle=2pi). </span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> newadc </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">readADC1_from_ISR</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//read ADC voltage</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">writeDAC</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">amplitude</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">nextSin</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//DAC output is sin(2*pi*cycle) </span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> multiplied </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> newadc </span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain"> nextSinWithPhase</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//put phase in units if degrees</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">writeDAC</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">2</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">multiplied</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  cycle </span><span class="token operator" style="color:#66d9ef">+=</span><span class="token plain"> frequency </span><span class="token operator" style="color:#66d9ef">/</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">1e6</span><span class="token operator" style="color:#66d9ef">/</span><span class="token plain">SampleRate</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//1e6/SampleRate is sample freq (500kHz);  freq normed to that</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">cycle </span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> cycle </span><span class="token operator" style="color:#66d9ef">-=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//reset phase so no overflows</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  nextSin </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">sin</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">2</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">PI</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">cycle</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain">      </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  nextSinWithPhase </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">sin</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">2</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">PI</span><span class="token operator" style="color:#66d9ef">*</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">cycle </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> phase</span><span class="token operator" style="color:#66d9ef">/</span><span class="token number" style="color:#ae81ff">360</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now we can adjust the phase (and frequency and amplitude) over the serial port:</p><div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token inserted-arrow inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">&gt;</span><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic">&gt;phase 180</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token deleted-arrow deleted prefix deleted" style="color:#d98672;font-style:italic">&lt;</span><span class="token deleted-arrow deleted line" style="color:#d98672;font-style:italic">&lt; phase is 1.8000000e+02</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And when we do that, our trig equation becomes </p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>s</mi><mi>i</mi><mi>n</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>∗</mo><mi>s</mi><mi>i</mi><mi>n</mi><mo stretchy="false">(</mo><mo>−</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mo fence="false">(</mo><mi>c</mi><mi>o</mi><mi>s</mi><mo stretchy="false">(</mo><mn>2</mn><mi>x</mi><mo stretchy="false">)</mo><mo>−</mo><mn>1</mn><mo fence="false">)</mo></mrow><annotation encoding="application/x-tex">sin(x) * sin(-x) = \frac{1}{2} \big(cos(2 x) - 1 \big)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord">−</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="delimsizing size1">(</span></span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord">2</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1.20001em;vertical-align:-0.35001em"></span><span class="mord">1</span><span class="mord"><span class="delimsizing size1">)</span></span></span></span></span></span></div><p>The same setup on an O-scope now looks like:</p><p><img loading="lazy" alt="img" src="/assets/images/LockIn-Oscope-P2-dde1ab5be1da65ebf19d524689bc7543.png" width="800" height="480" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="filtering">Filtering<a href="#filtering" class="hash-link" aria-label="Direct link to Filtering" title="Direct link to Filtering">​</a></h2><p>Often however, the oscillation at twice the reference frequency (2f) isn&#x27;t desired and we want to filter it out. We will use the simple first-order IIR filter described in more detail  in <a href="/Quarto/Examples/Filter#the-digital-filter">Digital Filter section of the Analog Filter Example</a>. To set the cut-off frequency to will use a custom qCommand function so we can input a frequency in Hz and calculate that right value of <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em"></span><span class="mord mathnormal" style="margin-right:0.0037em">α</span></span></span></span></span> for the filter. Here&#x27;s the code:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token macro property directive-hash" style="color:#f92672">#</span><span class="token macro property directive keyword" style="color:#66d9ef">include</span><span class="token macro property" style="color:#f92672"> </span><span class="token macro property string" style="color:#a6e22e">&quot;qCommand.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">qCommand qC</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">const</span><span class="token plain"> uint SampleRate </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">2</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> frequency </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">10e3</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> phase </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> amplitude </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">5</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> filter </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">1e3</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//default 1kHz</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> alpha </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0.012488</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// alpha for default 1 kHz</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> output </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">setup</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">void</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">configureADC</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">SampleRate</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">BIPOLAR_10V</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">getADC1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// Have ADC take measurement every 2us, ±10V range</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  qC</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">assignVariable</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;Freq&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token operator" style="color:#66d9ef">&amp;</span><span class="token plain">frequency</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  qC</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">assignVariable</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;Phase&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token operator" style="color:#66d9ef">&amp;</span><span class="token plain">phase</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  qC</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">assignVariable</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;Amp&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token operator" style="color:#66d9ef">&amp;</span><span class="token plain">amplitude</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  qC</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">assignVariable</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;Output&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token operator" style="color:#66d9ef">&amp;</span><span class="token plain">output</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  qC</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">addCommand</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;Filter&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token operator" style="color:#66d9ef">&amp;</span><span class="token plain">adjFilter</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">loop</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">void</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  qC</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">readSerial</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">Serial</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  qC</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">readSerial</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">Serial2</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">getADC1</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">void</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> nextSin </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> nextSinWithPhase </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> cycle </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//track phase/(2*pi) which is cycle fraction (one cycle=2pi).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> newadc </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">readADC1_from_ISR</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//read ADC voltage</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">writeDAC</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">amplitude</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">nextSin</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//DAC output is sin(2*pi*cycle)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> multiplied </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> newadc </span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain"> nextSinWithPhase</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//put phase in units if degrees</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  output </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> alpha </span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain"> multiplied </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">1</span><span class="token operator" style="color:#66d9ef">-</span><span class="token plain">alpha</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain"> output</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//apply IIR filter on multiplied value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#e6db74">writeDAC</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">2</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">output</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  cycle </span><span class="token operator" style="color:#66d9ef">+=</span><span class="token plain"> frequency </span><span class="token operator" style="color:#66d9ef">/</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">1e6</span><span class="token operator" style="color:#66d9ef">/</span><span class="token plain">SampleRate</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//1e6/SampleRate is sample freq (500kHz);  freq normed to that</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">cycle </span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> cycle </span><span class="token operator" style="color:#66d9ef">-=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//reset phase so no overflows</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  nextSin </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">sin</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">2</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">PI</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">cycle</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  nextSinWithPhase </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">sin</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">2</span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain">PI</span><span class="token operator" style="color:#66d9ef">*</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">cycle </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> phase</span><span class="token operator" style="color:#66d9ef">/</span><span class="token number" style="color:#ae81ff">360</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">adjFilter</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">qCommand</span><span class="token operator" style="color:#66d9ef">&amp;</span><span class="token plain"> qC</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> Stream</span><span class="token operator" style="color:#66d9ef">&amp;</span><span class="token plain"> S</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"> qC</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">next</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">!=</span><span class="token plain"> </span><span class="token constant" style="color:#e6db74">NULL</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> filterInput </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">atof</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">qC</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">current</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">filterInput </span><span class="token operator" style="color:#66d9ef">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      filter </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//keep frequency filter positive</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      alpha </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//at filter = 0Hz, output cannot update, alpha is zero</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">else</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">filterInput </span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">250e3</span><span class="token operator" style="color:#66d9ef">/</span><span class="token plain">SampleRate</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">// IIR no valid beyond sampleRate/4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      filter </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> INFINITY</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      alpha </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#8292a2;font-style:italic">//no filtering</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      filter </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> filterInput</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> y </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">tan</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">PI </span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain"> filter </span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain"> SampleRate </span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">1e-6</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      alpha </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">2</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">*</span><span class="token plain"> y </span><span class="token operator" style="color:#66d9ef">/</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">y</span><span class="token operator" style="color:#66d9ef">+</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain">        </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    S</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">printf</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;The filter frequency is %f (and alpha=%f)\n&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">filter</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">alpha</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now we can adjust the filtering on the fly:</p><div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token inserted-arrow inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">&gt;</span><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic">&gt; filter 20e3</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token deleted-arrow deleted prefix deleted" style="color:#d98672;font-style:italic">&lt;</span><span class="token deleted-arrow deleted line" style="color:#d98672;font-style:italic">&lt; The filter frequency is 20000.000000 (and alpha=0.224320)</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-arrow deleted line" style="color:#d98672;font-style:italic"></span><span class="token inserted-arrow inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">&gt;</span><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic">&gt; filter 1e3</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token deleted-arrow deleted prefix deleted" style="color:#d98672;font-style:italic">&lt;</span><span class="token deleted-arrow deleted line" style="color:#d98672;font-style:italic">&lt; The filter frequency is 1000.000000 (and alpha=0.012488)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Below are two O-scope screen shots showing the filtered output in cyan with a reference grey trace showing the results without any filtering. The first image shows a 20 kHz filter, causing the amplitude of the 2f frequency component to be reduced by <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msqrt><mn>2</mn></msqrt></mrow><annotation encoding="application/x-tex">\sqrt{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.13278em"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.90722em"><span class="svg-align" style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord" style="padding-left:0.833em"><span class="mord">2</span></span></span><span style="top:-2.86722em"><span class="pstrut" style="height:3em"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em"><svg width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.13278em"><span></span></span></span></span></span></span></span></span></span> . The second image is with a filter of 1kHz where the 2f component is reduced by ~20.</p><p><img loading="lazy" alt="img" src="/assets/images/LockIn-Oscope-P3-82f4d492f14e3812b8003d20c07d9e3b.png" width="800" height="480" class="img_ev3q"></p><p><img loading="lazy" alt="img" src="/assets/images/LockIn-Oscope-P4-cacd11e9882f14f365dd4dc5ba9f368e.png" width="800" height="480" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-the-lock-in">Using the Lock-in<a href="#using-the-lock-in" class="hash-link" aria-label="Direct link to Using the Lock-in" title="Direct link to Using the Lock-in">​</a></h2><p>With this setup, we can actually measure the phase-delay caused by the <em>Quarto</em>. If the <em>Quarto</em> had zero signal delay (infinite bandwidth), then the output signal would be maximized with a phase shift of 0° and, conversely the output would be zero with a phase shift of 90°.  But the process reading, writing and filtering analog data takes some time, causing a phase shift relative to the expected value. By adjusting the phase we can compensate for this shift and measure the phase shift caused by the <em>Quarto</em>. </p><p>The first step is to setup an agressive filter so we can precisely measure the output voltage. It is easier to measure when a signal is at 0V than when it is maximized, so we will look for the phase necessary to get zero output (ideal is 90°). Also, we will use the command &#x27;Output&#x27; to measure the output voltage directly from the <em>Quarto</em>.</p><div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token inserted-arrow inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">&gt;</span><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic">&gt; filter 10</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token deleted-arrow deleted prefix deleted" style="color:#d98672;font-style:italic">&lt;</span><span class="token deleted-arrow deleted line" style="color:#d98672;font-style:italic">&lt; The filter frequency is 10.000000 (and alpha=0.000126)</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-arrow deleted line" style="color:#d98672;font-style:italic"></span><span class="token inserted-arrow inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">&gt;</span><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic">&gt; phase 90</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-arrow inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">&gt;</span><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic">&gt; phase is 9.000000e+01</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token deleted-arrow deleted prefix deleted" style="color:#d98672;font-style:italic">&lt;</span><span class="token deleted-arrow deleted line" style="color:#d98672;font-style:italic">&lt; output</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-arrow deleted line" style="color:#d98672;font-style:italic"></span><span class="token inserted-arrow inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">&gt;</span><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic">&gt; output is -0.767086</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-arrow inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">&gt;</span><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic">&gt; output is -0.768395</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-arrow inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">&gt;</span><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic">&gt; output is -0.767349</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-arrow inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">&gt;</span><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic">&gt; output is -0.767659</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-arrow inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">&gt;</span><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic">&gt; output is -0.766547</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-arrow inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">&gt;</span><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic">&gt; output is -0.766430</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-arrow inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">&gt;</span><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic">&gt; output is -0.768701</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-arrow inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">&gt;</span><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic">&gt; output is -0.766498</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token inserted-arrow inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">&gt;</span><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic">&gt; output is -0.766945</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> We can see that with a 90° phase shift, the output is -0.767V with a standard deviation of about 800uV, which should be low enough make a precise measurement. If we change the phase, we can see the output change:</p><div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token inserted-arrow inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">&gt;</span><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic">&gt; phase 95</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token deleted-arrow deleted prefix deleted" style="color:#d98672;font-style:italic">&lt;</span><span class="token deleted-arrow deleted line" style="color:#d98672;font-style:italic">&lt; phase is 9.500000e+01</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-arrow deleted line" style="color:#d98672;font-style:italic"></span><span class="token inserted-arrow inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">&gt;</span><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic">&gt; output</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token deleted-arrow deleted prefix deleted" style="color:#d98672;font-style:italic">&lt;</span><span class="token deleted-arrow deleted line" style="color:#d98672;font-style:italic">&lt; output is -0.970563</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-arrow deleted line" style="color:#d98672;font-style:italic"></span><span class="token inserted-arrow inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">&gt;</span><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic">&gt; phase 85</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token deleted-arrow deleted prefix deleted" style="color:#d98672;font-style:italic">&lt;</span><span class="token deleted-arrow deleted line" style="color:#d98672;font-style:italic">&lt; phase is 8.500000e+01</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-arrow deleted line" style="color:#d98672;font-style:italic"></span><span class="token inserted-arrow inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">&gt;</span><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic">&gt; output</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token deleted-arrow deleted prefix deleted" style="color:#d98672;font-style:italic">&lt;</span><span class="token deleted-arrow deleted line" style="color:#d98672;font-style:italic">&lt; output is -0.559031</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Experimentally, the zero crossing was found around 72.1°:</p><div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token inserted-arrow inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">&gt;</span><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic">&gt; phase 72.1</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token deleted-arrow deleted prefix deleted" style="color:#d98672;font-style:italic">&lt;</span><span class="token deleted-arrow deleted line" style="color:#d98672;font-style:italic">&lt; phase is 7.210000e+01</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-arrow deleted line" style="color:#d98672;font-style:italic"></span><span class="token inserted-arrow inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">&gt;</span><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic">&gt; output</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token inserted-arrow inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token deleted-arrow deleted prefix deleted" style="color:#d98672;font-style:italic">&lt;</span><span class="token deleted-arrow deleted line" style="color:#d98672;font-style:italic">&lt; output is -8.996903e-04</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-arrow deleted line" style="color:#d98672;font-style:italic"></span><span class="token deleted-arrow deleted prefix deleted" style="color:#d98672;font-style:italic">&lt;</span><span class="token deleted-arrow deleted line" style="color:#d98672;font-style:italic">&lt; output is 1.919594e-04</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token deleted-arrow deleted line" style="color:#d98672;font-style:italic"></span><span class="token deleted-arrow deleted prefix deleted" style="color:#d98672;font-style:italic">&lt;</span><span class="token deleted-arrow deleted line" style="color:#d98672;font-style:italic">&lt; output is -2.021857e-03</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is a phase shift of about 18° from the expected 90°. See <a href="/Quarto/AppNotes/AnalogResponseTime">Analog Response Time</a> for more details, but this is expected since the <em>Quarto</em> has 100 kHz of servo bandwidth when sampling at 2µs. That works out to 180° phase shift at 100 kHz, which would be an 18° phase-shift at 10 kHz.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/Quarto/Examples/Filter"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Analog Filter</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/Quarto/Examples/Servo"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">PID Servo</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#generate-reference" class="table-of-contents__link toc-highlight">Generate Reference</a></li><li><a href="#demodulate" class="table-of-contents__link toc-highlight">Demodulate</a><ul><li><a href="#speed-optimization" class="table-of-contents__link toc-highlight">Speed Optimization</a></li><li><a href="#data" class="table-of-contents__link toc-highlight">Data</a></li></ul></li><li><a href="#adjustable-parameters" class="table-of-contents__link toc-highlight">Adjustable Parameters</a></li><li><a href="#filtering" class="table-of-contents__link toc-highlight">Filtering</a></li><li><a href="#using-the-lock-in" class="table-of-contents__link toc-highlight">Using the Lock-in</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title"></div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Privacy">Privacy Policy</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">62 Salisbury Ave, Toronto ON, M4X 1C4 | Ontario, Canada | Phone: (720)-741-1556 <br> Copyright © 2023 <div class="baloo">qNimble</div></div></div></div></footer></div>
<script src="/assets/js/runtime~main.41bc4f4f.js"></script>
<script src="/assets/js/main.3666540f.js"></script>
</body>
</html>